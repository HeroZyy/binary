name: Build Android APK

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ”§ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: ğŸ“¦ Cache Buildozer
      uses: actions/cache@v4
      with:
        path: |
          .buildozer
          ~/.buildozer
        key: ${{ runner.os }}-buildozer-${{ hashFiles('buildozer.spec') }}
        restore-keys: |
          ${{ runner.os }}-buildozer-
    
    - name: ğŸ—ï¸ Build with Buildozer
      uses: ArtemSBulgakov/buildozer-action@v1
      id: buildozer
      with:
        command: buildozer android debug
        buildozer_version: stable
    
    - name: ğŸ“¤ Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: apk-debug-${{ github.sha }}
        path: ${{ steps.buildozer.outputs.filename }}
        retention-days: 30
    
    - name: ğŸ“Š APK Info
      run: |
        echo "âœ… APK æ‰“åŒ…æˆåŠŸï¼"
        echo "ğŸ“¦ æ–‡ä»¶å: ${{ steps.buildozer.outputs.filename }}"
        echo "ğŸ“ æ–‡ä»¶å¤§å°: $(du -h ${{ steps.buildozer.outputs.filename }} | cut -f1)"
        echo "ğŸ”— ä¸‹è½½é“¾æ¥: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
    
    - name: ğŸš€ Create Release (on tag)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: ${{ steps.buildozer.outputs.filename }}
        body: |
          ## ğŸ“± Auto Binarization Demo v${{ github.ref_name }}
          
          ### ğŸ“¦ ä¸‹è½½
          - APK æ–‡ä»¶å·²é™„åŠ åœ¨ä¸‹æ–¹
          
          ### âœ¨ åŠŸèƒ½
          - âœ… å›¾åƒäºŒå€¼åŒ–ï¼ˆone_step ç®—æ³•ï¼‰
          - âœ… OpenCV æ”¯æŒ
          - âœ… è‡ªé€‚åº”é˜ˆå€¼å¤„ç†
          - âœ… é˜´å½±æ¶ˆé™¤
          
          ### ğŸ“Š æŠ€æœ¯æ ˆ
          - Python 3.11
          - Kivy 2.1.0
          - OpenCV 4.5+
          - NumPy
          
          ### ğŸ“± å®‰è£…
          1. ä¸‹è½½ APK æ–‡ä»¶
          2. åœ¨ Android è®¾å¤‡ä¸Šå®‰è£…
          3. å…è®¸æœªçŸ¥æ¥æº
          4. æˆäºˆå­˜å‚¨æƒé™
          
          ### ğŸ› é—®é¢˜åé¦ˆ
          å¦‚æœ‰é—®é¢˜ï¼Œè¯·åœ¨ Issues ä¸­åé¦ˆ
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

