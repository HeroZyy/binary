name: Build Android APK

on:
  push:
    branches: [ main, master, develop ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-20.04

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v3

    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: ğŸ“¦ Install system dependencies
      run: |
        sudo apt-get update -qq
        sudo apt-get install -y \
          git zip unzip openjdk-11-jdk wget \
          autoconf libtool pkg-config \
          zlib1g-dev libncurses5-dev \
          libffi-dev libssl-dev cmake \
          libltdl-dev ccache

    - name: ğŸ“¦ Install Buildozer
      run: |
        pip install --upgrade pip setuptools wheel
        pip install buildozer==1.5.0 cython==0.29.36

    - name: ğŸ“¦ Cache Buildozer global directory
      uses: actions/cache@v3
      with:
        path: ~/.buildozer
        key: buildozer-global-${{ hashFiles('buildozer.spec') }}
        restore-keys: |
          buildozer-global-

    - name: ğŸ“¦ Cache Buildozer directory
      uses: actions/cache@v3
      with:
        path: .buildozer
        key: buildozer-${{ hashFiles('buildozer.spec') }}
        restore-keys: |
          buildozer-

    - name: ğŸ—ï¸ Build APK
      run: |
        yes | buildozer android debug || buildozer android debug
      env:
        ANDROID_SDK_ROOT: /opt/android-sdk
        ANDROID_HOME: /opt/android-sdk
    
    - name: ğŸ“Š Find APK file
      id: find_apk
      run: |
        APK_FILE=$(find bin -name "*.apk" -type f | head -n 1)
        if [ -z "$APK_FILE" ]; then
          echo "âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ° APK æ–‡ä»¶"
          echo "bin ç›®å½•å†…å®¹ï¼š"
          ls -la bin/ || echo "bin ç›®å½•ä¸å­˜åœ¨"
          exit 1
        fi
        echo "apk_path=$APK_FILE" >> $GITHUB_OUTPUT
        echo "apk_name=$(basename $APK_FILE)" >> $GITHUB_OUTPUT
        echo "âœ… æ‰¾åˆ° APK: $APK_FILE"
        echo "ğŸ“ æ–‡ä»¶å¤§å°: $(du -h $APK_FILE | cut -f1)"

    - name: ğŸ“¤ Upload APK
      uses: actions/upload-artifact@v3
      with:
        name: android-apk
        path: ${{ steps.find_apk.outputs.apk_path }}
        retention-days: 30

    - name: ğŸ“Š APK Info
      run: |
        echo "=================================="
        echo "âœ… APK æ‰“åŒ…æˆåŠŸï¼"
        echo "=================================="
        echo "ğŸ“¦ æ–‡ä»¶å: ${{ steps.find_apk.outputs.apk_name }}"
        echo "ğŸ“ æ–‡ä»¶å¤§å°: $(du -h ${{ steps.find_apk.outputs.apk_path }} | cut -f1)"
        echo "ğŸ”— ä¸‹è½½é“¾æ¥: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        echo "=================================="
    
    - name: ğŸš€ Create Release (on tag)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: ${{ steps.find_apk.outputs.apk_path }}
        body: |
          ## ğŸ“± Auto Binarization Demo ${{ github.ref_name }}

          ### ğŸ“¥ ä¸‹è½½
          APK æ–‡ä»¶å·²é™„åŠ åœ¨ä¸‹æ–¹

          ### âœ¨ åŠŸèƒ½
          - âœ… å›¾åƒäºŒå€¼åŒ–ï¼ˆone_step ç®—æ³•ï¼‰
          - âœ… OpenCV æ”¯æŒ
          - âœ… è‡ªé€‚åº”é˜ˆå€¼å¤„ç†
          - âœ… é˜´å½±æ¶ˆé™¤

          ### ğŸ“Š æŠ€æœ¯æ ˆ
          - Python 3.9
          - Kivy 2.1.0
          - OpenCV 4.5+
          - NumPy

          ### ğŸ“± å®‰è£…
          1. ä¸‹è½½ APK æ–‡ä»¶
          2. åœ¨ Android è®¾å¤‡ä¸Šå®‰è£…
          3. å…è®¸æœªçŸ¥æ¥æº
          4. æˆäºˆå­˜å‚¨æƒé™

          ### ğŸ› é—®é¢˜åé¦ˆ
          å¦‚æœ‰é—®é¢˜ï¼Œè¯·åœ¨ Issues ä¸­åé¦ˆ
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

