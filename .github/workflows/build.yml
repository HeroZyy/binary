name: Build APK (Docker)

on:
  push:
    branches: [ main, master, develop ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ³ Build APK with Docker
      run: |
        docker run --rm \
          -v "$PWD":/home/user/hostcwd \
          -w /home/user/hostcwd \
          kivy/buildozer:latest \
          buildozer android debug
    
    - name: ğŸ“¤ Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: android-apk
        path: bin/*.apk
        retention-days: 30
    
    - name: ğŸ“Š APK Info
      run: |
        APK_FILE=$(find bin -name "*.apk" -type f | head -n 1)
        if [ -n "$APK_FILE" ]; then
          echo "âœ… APK æ‰“åŒ…æˆåŠŸï¼"
          echo "ğŸ“¦ æ–‡ä»¶: $(basename $APK_FILE)"
          echo "ğŸ“ å¤§å°: $(du -h $APK_FILE | cut -f1)"
        else
          echo "âŒ æœªæ‰¾åˆ° APK æ–‡ä»¶"
          exit 1
        fi
    
    - name: ğŸš€ Create Release (on tag)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: bin/*.apk
        body: |
          ## ğŸ“± Auto Binarization Demo ${{ github.ref_name }}
          
          ### ä¸‹è½½
          APK æ–‡ä»¶å·²é™„åŠ åœ¨ä¸‹æ–¹
          
          ### åŠŸèƒ½
          - âœ… å›¾åƒäºŒå€¼åŒ–ï¼ˆone_step ç®—æ³•ï¼‰
          - âœ… OpenCV æ”¯æŒ
          - âœ… è‡ªé€‚åº”é˜ˆå€¼å¤„ç†
          - âœ… é˜´å½±æ¶ˆé™¤
          
          ### å®‰è£…
          1. ä¸‹è½½ APK
          2. åœ¨ Android è®¾å¤‡ä¸Šå®‰è£…
          3. å…è®¸æœªçŸ¥æ¥æº
          4. æˆäºˆå­˜å‚¨æƒé™
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

